<% layout('layouts/boilerplate')%>

<!-- 引入样式 -->
<link rel="stylesheet" href="/styles/campground-show.css" />
<link rel="stylesheet" href="/styles/star.css" />

<div class="row">
  <!-- 左侧：campground详情 -->
  <div class="col-md-6">
    <div class="campground-card">
      <!-- 图片区域 -->
      <div class="image-section">
        <% if(campground.image.length) { %> <% if(campground.image.length > 1) {
        %>
        <!-- 多图片轮播 -->
        <div
          id="campgroundCarousel"
          class="carousel slide"
          data-bs-ride="carousel"
        >
          <div class="carousel-inner">
            <% campground.image.forEach((img, i) => { %>
            <div class="carousel-item <%= i === 0 ? 'active' : '' %>">
              <img
                src="<%= img.url %>"
                class="carousel-image"
                alt="campground image"
              />
            </div>
            <% }) %>
          </div>
          <button
            class="carousel-control-prev"
            type="button"
            data-bs-target="#campgroundCarousel"
            data-bs-slide="prev"
          >
            <span class="carousel-control-prev-icon"></span>
          </button>
          <button
            class="carousel-control-next"
            type="button"
            data-bs-target="#campgroundCarousel"
            data-bs-slide="next"
          >
            <span class="carousel-control-next-icon"></span>
          </button>
        </div>
        <% } else { %>
        <!-- 单张图片 -->
        <img
          src="<%= campground.image[0].url %>"
          class="single-image"
          alt="campground image"
        />
        <% } %> <% } else { %>
        <img
          src="https://picsum.photos/600/400"
          class="single-image"
          alt="placeholder"
        />
        <% } %>
      </div>

      <!-- 内容区域 -->
      <div class="content-section">
        <h2 class="campground-title"><%= campground.title %></h2>
        <p class="campground-description"><%= campground.description %></p>

        <div class="info-grid">
          <div class="info-item">
            <strong>Location:</strong> <%= campground.location %>
          </div>
          <div class="info-item">
            <strong>Price:</strong> $<%= campground.price %>/night
          </div>
          <div class="info-item">
            <strong>By:</strong> <%= campground.author.username %>
          </div>
        </div>

        <!-- 操作按钮 -->
        <% if (currentUser && campground.author.equals(currentUser._id)) {%>
        <div class="action-buttons">
          <a
            href="/campgrounds/<%=campground._id%>/edit"
            class="btn btn-primary"
            >Edit</a
          >
          <form
            class="d-inline"
            action="/campgrounds/<%=campground._id%>?_method=DELETE"
            method="POST"
          >
            <button class="btn btn-danger">Delete</button>
          </form>
        </div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- 右侧：地图和评论 -->
  <div class="col-md-6">
    <!-- 地图 -->
    <div class="map-card">
      <h5>Location</h5>
      <div id="map" class="map-container"></div>
    </div>

    <!-- 评论表单 -->
    <% if (currentUser) { %>
    <div class="review-form-card">
      <h5>Leave a Review</h5>
      <form
        action="/campgrounds/<%=campground._id%>/reviews"
        method="POST"
        class="validated-form"
        novalidate
      >
        <div class="rating-section">
          <fieldset class="starability-basic">
            <legend>Rating:</legend>
            <input type="radio" id="rate1" name="review[rating]" value="1" />
            <label for="rate1">1 star</label>
            <input type="radio" id="rate2" name="review[rating]" value="2" />
            <label for="rate2">2 stars</label>
            <input
              type="radio"
              id="rate3"
              name="review[rating]"
              value="3"
              checked
            />
            <label for="rate3">3 stars</label>
            <input type="radio" id="rate4" name="review[rating]" value="4" />
            <label for="rate4">4 stars</label>
            <input type="radio" id="rate5" name="review[rating]" value="5" />
            <label for="rate5">5 stars</label>
          </fieldset>
        </div>

        <div class="review-text">
          <textarea
            class="form-control"
            name="review[body]"
            placeholder="Write your review..."
            rows="3"
            required
          ></textarea>
        </div>

        <button type="submit" class="btn btn-primary">Submit Review</button>
      </form>
    </div>
    <% } %>

    <!-- 评论列表 -->
    <% if (campground.reviews.length > 0) { %>
    <div class="reviews-section">
      <h5>Reviews</h5>
      <% for(let review of campground.reviews) { %>
      <div class="review-item">
        <div class="review-header">
          <strong><%= review.author.username %></strong>
          <div class="starability-result" data-rating="<%= review.rating %>">
            <%= review.rating %> stars
          </div>
        </div>
        <p class="review-body"><%= review.body %></p>
        <% if (currentUser && review.author.equals(currentUser._id)) {%>
        <form
          action="/campgrounds/<%=campground._id%>/reviews/<%=review._id%>?_method=DELETE"
          method="POST"
        >
          <button class="btn btn-sm btn-danger">Delete</button>
        </form>
        <% } %>
      </div>
      <% } %>
    </div>
    <% } %>
  </div>
</div>

<script>
  const mapToken = "<%- process.env.MAPBOX_TOKEN %>";
  const campground = <%- JSON.stringify(campground) %>;
</script>
<script src="/js/showPageMap.js"></script>
